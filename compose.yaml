services:
  # Production app
  app:
    build:
      context: .
      target: production
    ports:
      - "8080:8080"
    environment:
      - PORT=8080
      - PROJECT_ID
      - TOPIC_ID
      - BUILDKITE_WEBHOOK_TOKEN
      - GOOGLE_APPLICATION_CREDENTIALS=/tmp/credentials.json
    volumes:
      - ${GOOGLE_APPLICATION_CREDENTIALS:-}:/tmp/credentials.json:ro

  # Development base service
  dev:
    profiles: [dev, ci]
    build:
      context: .
      target: dev
    volumes:
      - .:/app
      - go-cache:/go
    environment:
      - CGO_ENABLED=0
      - GOCACHE=/go/cache
      - GOMODCACHE=/go/mod

  # CI services
  test:
    profiles: [ci]
    extends:
      service: dev
    command: go test -v -race -coverprofile=/app/coverage.txt -covermode=atomic ./...
    environment:
      - CGO_ENABLED=1

  lint:
    profiles: [ci]
    extends:
      service: dev
    command: golangci-lint run --timeout=5m

  fmt:
    profiles: [ci]
    extends:
      service: dev
    command: gofumpt -l .

  gosec:
    profiles: [ci]
    extends:
      service: dev
    command: gosec -fmt json -out /app/gosec-report.json -stdout -verbose=text ./...

  govulncheck:
    profiles: [ci]
    extends:
      service: dev
    command: govulncheck ./...

volumes:
  go-cache:
